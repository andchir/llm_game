name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create deployment directory
        run: |
          mkdir -p _site
          cp -r static/* _site/

      - name: Create config file for GitHub Pages
        run: |
          cat > _site/config.js << 'EOF'
          // Configuration for GitHub Pages deployment
          // Users can modify this to point to their own backend server
          window.GAME_CONFIG = {
            // Default: try to connect to a WebSocket server on the same host
            // For production, set this to your actual backend server URL
            wsUrl: window.location.protocol === 'https:'
              ? 'wss://' + window.location.host + '/ws'
              : 'ws://' + window.location.host + '/ws',

            // Alternative: Use a demo server (if available)
            // wsUrl: 'wss://your-backend-server.com/ws',

            // For local testing:
            // wsUrl: 'ws://localhost:8080/ws',
          };
          EOF

      - name: Update index.html to include config
        run: |
          sed -i 's|<script src="/static/game.js"></script>|<script src="config.js"></script>\n    <script src="game.js"></script>|' _site/index.html

      - name: Create instructions page
        run: |
          cat > _site/README.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>LLM Game - Deployment Instructions</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background-color: #1a1a1a;
                      color: #ffffff;
                  }
                  h1, h2 { color: #4CAF50; }
                  pre {
                      background-color: #2a2a2a;
                      padding: 15px;
                      border-radius: 5px;
                      overflow-x: auto;
                  }
                  code {
                      background-color: #2a2a2a;
                      padding: 2px 6px;
                      border-radius: 3px;
                  }
                  a {
                      color: #4CAF50;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .warning {
                      background-color: #ff9800;
                      color: #000;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .info {
                      background-color: #2196F3;
                      color: #fff;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
              </style>
          </head>
          <body>
              <h1>üéÆ LLM Game - Deployment Instructions</h1>

              <div class="info">
                  <strong>‚ÑπÔ∏è Note:</strong> This page contains the static files for the game frontend.
                  To play the game, you need to deploy the backend server separately.
              </div>

              <h2>üöÄ Quick Start Options</h2>

              <h3>Option 1: Run Locally (Recommended for Testing)</h3>
              <pre><code># Clone the repository
          git clone https://github.com/andchir/llm_game.git
          cd llm_game

          # Install dependencies
          pip install -r requirements.txt

          # Start the server
          python server/game_server.py

          # Open your browser
          # http://localhost:8080</code></pre>

              <h3>Option 2: Deploy Backend to Free Hosting</h3>
              <p>Deploy the Python backend to a free hosting service:</p>

              <h4>A. Using Render.com (Free Tier)</h4>
              <ol>
                  <li>Create account at <a href="https://render.com" target="_blank">render.com</a></li>
                  <li>Create a new "Web Service"</li>
                  <li>Connect your GitHub repository</li>
                  <li>Set build command: <code>pip install -r requirements.txt</code></li>
                  <li>Set start command: <code>python server/game_server.py</code></li>
                  <li>Deploy and get your WebSocket URL</li>
                  <li>Update <code>config.js</code> with your backend URL</li>
              </ol>

              <h4>B. Using Railway.app (Free Tier)</h4>
              <ol>
                  <li>Create account at <a href="https://railway.app" target="_blank">railway.app</a></li>
                  <li>Create a new project from GitHub repo</li>
                  <li>Railway will auto-detect Python and deploy</li>
                  <li>Get your deployment URL</li>
                  <li>Update <code>config.js</code> with your backend URL</li>
              </ol>

              <h4>C. Using Fly.io (Free Tier)</h4>
              <ol>
                  <li>Install flyctl: <a href="https://fly.io/docs/hands-on/install-flyctl/" target="_blank">installation guide</a></li>
                  <li>Run: <code>fly launch</code> in your project directory</li>
                  <li>Follow the prompts to deploy</li>
                  <li>Get your deployment URL</li>
                  <li>Update <code>config.js</code> with your backend URL</li>
              </ol>

              <h3>Option 3: Production Deployment with systemd</h3>
              <p>For detailed instructions on deploying to your own Ubuntu server with systemd, nginx, and SSL, see the
              <a href="https://github.com/andchir/llm_game/blob/main/DEPLOYMENT.md" target="_blank">DEPLOYMENT.md</a> file.</p>

              <h2>‚öôÔ∏è Configuration</h2>

              <p>After deploying your backend, update <code>config.js</code> to point to your server:</p>
              <pre><code>window.GAME_CONFIG = {
              wsUrl: 'wss://your-backend-url.com/ws',
          };</code></pre>

              <h2>üìñ Documentation</h2>
              <ul>
                  <li><a href="https://github.com/andchir/llm_game" target="_blank">GitHub Repository</a></li>
                  <li><a href="https://github.com/andchir/llm_game/blob/main/README.md" target="_blank">README.md</a></li>
                  <li><a href="https://github.com/andchir/llm_game/blob/main/DEPLOYMENT.md" target="_blank">DEPLOYMENT.md</a></li>
              </ul>

              <h2>üéÆ Play Now</h2>
              <p>If you have configured your backend server, you can:</p>
              <p><a href="index.html" style="background-color: #4CAF50; color: white; padding: 15px 30px; border-radius: 5px; display: inline-block; margin-top: 10px;">‚ñ∂ Start Playing</a></p>

              <div class="warning">
                  <strong>‚ö†Ô∏è Warning:</strong> The game requires a running WebSocket backend server to function.
                  The frontend files alone cannot run the multiplayer game.
              </div>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
